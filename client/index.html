<!DOCTYPE html>
<html>
<head>
  <title>Yoink</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: system-ui; padding: 24px; max-width: 900px; margin: auto; }
    input, button { padding: 10px; margin: 6px 0; }
    .hidden { display: none; }
    .timer { font-size: 22px; font-weight: 900; color: #c00; margin: 10px 0; }
    .grid { display: grid; grid-template-columns: repeat(4, 70px); gap: 10px; margin-top: 14px; }
    .tile {
      width: 70px; height: 70px; border: 1px solid #ccc; border-radius: 12px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 24px; font-weight: 900; cursor: pointer; background: white;
      user-select: none;
    }
    .tile small { font-size: 11px; opacity: 0.6; font-weight: 700; }
    .bank { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .bankTile {
      width: 58px; height: 58px; border: 1px solid #aaa; border-radius: 12px;
      display: inline-flex; justify-content: center; align-items: center;
      font-weight: 900; cursor: pointer; user-select: none; background: #fff;
      font-size: 22px;
    }
    .bankTile.selected { outline: 3px solid #4a90e2; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #eee; font-weight: 800; }
    #result { font-weight: 900; font-size: 18px; }
    pre { background: #111; color: #0f0; padding: 12px; border-radius: 12px; overflow: auto; }
    .debug { background:#f6f6f6; border:1px solid #ddd; padding:10px; border-radius:12px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>

<h1>YOINK</h1>

<!-- LOBBY -->
<div id="lobbyScreen">
  <div class="row">
    <input id="name" placeholder="Nickname" />
  </div>

  <div class="row">
    <button onclick="createRoom()">Create Room</button>
    <input id="code" placeholder="Room Code" style="text-transform: uppercase;" />
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <div class="row">
    <button onclick="startGame()">Start Game (Host Only)</button>
    <span class="pill">Bank limit: 7</span>
    <span class="pill" id="connPill">Socket: (starting)</span>
    <span class="pill" id="hostPill">Host: ?</span>
  </div>

  <div class="debug" id="debugLog">debug: page loaded</div>

  <h3>Lobby State</h3>
  <pre id="lobbyOutput"></pre>
</div>

<!-- GAME -->
<div id="gameScreen" class="hidden">
  <div class="row">
    <button onclick="leaveGame()">Leave Game</button>
    <div class="pill" id="scorePill"></div>
  </div>

  <div class="timer" id="timer"></div>

  <h3>4Ã—4 Pool (positions stay put)</h3>
  <div class="grid" id="pool"></div>

  <h3>Your Bank (click tiles to build word)</h3>
  <div class="bank" id="bank"></div>

  <div style="margin-top: 14px;">
    <div class="pill">Word: <span id="currentWord"></span></div>
  </div>

  <div class="row" style="margin-top: 10px;">
    <button onclick="submitWord()">Submit</button>
    <button onclick="clearWord()">Clear</button>
  </div>

  <div class="row" style="margin-top: 10px;">
    <div id="result"></div>
  </div>
</div>

<script>
const SERVER_URL = "https://yoink-j9pd.onrender.com";
const socket = io(SERVER_URL, { transports: ["websocket", "polling"] });

let currentRoom = null;
let selectedTileIds = [];

const lobbyScreen = document.getElementById("lobbyScreen");
const gameScreen  = document.getElementById("gameScreen");
const poolDiv = document.getElementById("pool");
const bankDiv = document.getElementById("bank");
const timerDiv = document.getElementById("timer");
const lobbyOutput = document.getElementById("lobbyOutput");
const currentWordSpan = document.getElementById("currentWord");
const resultDiv = document.getElementById("result");
const scorePill = document.getElementById("scorePill");
const hostPill = document.getElementById("hostPill");
const connPill = document.getElementById("connPill");
const debugLog = document.getElementById("debugLog");

function log(msg) {
  debugLog.textContent = "debug: " + msg;
}

socket.on("connect", () => {
  connPill.textContent = "Socket: connected";
  log("socket connected, id=" + socket.id);
});

socket.on("connect_error", (err) => {
  connPill.textContent = "Socket: ERROR";
  log("connect_error: " + (err?.message || err));
});

socket.on("disconnect", (reason) => {
  connPill.textContent = "Socket: disconnected";
  log("disconnected: " + reason);
});

socket.on("roomUpdate", (room) => {
  currentRoom = room;
  lobbyOutput.textContent = JSON.stringify(room, null, 2);

  const isHost = room.host === socket.id;
  hostPill.textContent = isHost ? "Host: YOU" : "Host: someone else";

  if (room.state === "ROUND_ACTIVE") {
    showGameScreen();
    renderGame(room);
    startTimer(room.roundEndTime);
  } else {
    showLobbyScreen();
  }
});

function showGameScreen() {
  lobbyScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
}

function showLobbyScreen() {
  gameScreen.classList.add("hidden");
  lobbyScreen.classList.remove("hidden");
  timerDiv.textContent = "";
  selectedTileIds = [];
  currentWordSpan.textContent = "";
  resultDiv.textContent = "";
}

function createRoom() {
  const nickname = document.getElementById("name").value.trim();
  if (!nickname) return alert("Enter a nickname");
  log("createRoom clicked");
  socket.emit("createRoom", { nickname }, (res) => {
    document.getElementById("code").value = res.code;
    alert("Room Code: " + res.code);
    log("room created: " + res.code);
  });
}

function joinRoom() {
  const nickname = document.getElementById("name").value.trim();
  const code = document.getElementById("code").value.toUpperCase().trim();
  if (!nickname) return alert("Enter a nickname");
  if (code.length < 4) return alert("Enter the room code");
  log("joinRoom clicked: " + code);
  socket.emit("joinRoom", { code, nickname }, (res) => {
    if (!res.ok) {
      alert(res.reason || "Room not found");
      log("join failed: " + (res.reason || "unknown"));
    } else {
      log("joined room: " + code);
    }
  });
}

function startGame() {
  log("startGame button clicked");
  if (!currentRoom) {
    alert("Join a room first");
    log("startGame blocked: no currentRoom");
    return;
  }

  socket.emit("startGame", { code: currentRoom.code }, (res) => {
    if (!res) {
      alert("No response from server on startGame (server is probably not updated)");
      log("startGame: no callback response");
      return;
    }
    if (!res.ok) {
      alert("Start failed: " + (res.reason || "unknown"));
      log("startGame failed: " + (res.reason || "unknown"));
      return;
    }
    log("startGame ok");
  });
}

function leaveGame() {
  showLobbyScreen();
}

function toggleSelect(tileId) {
  if (selectedTileIds.includes(tileId)) {
    selectedTileIds = selectedTileIds.filter((id) => id !== tileId);
  } else {
    selectedTileIds.push(tileId);
  }
  updateCurrentWord();
  renderGame(currentRoom);
}

function updateCurrentWord() {
  const you = currentRoom?.players?.[socket.id];
  const bank = you?.bank || [];
  const letters = selectedTileIds.map((id) => bank.find((t) => t.id === id)?.letter || "");
  currentWordSpan.textContent = letters.join("");
}

function clearWord() {
  selectedTileIds = [];
  updateCurrentWord();
  renderGame(currentRoom);
  resultDiv.textContent = "";
}

function submitWord() {
  if (!currentRoom) return;
  if (selectedTileIds.length === 0) return;

  socket.emit("submitWord", { code: currentRoom.code, tileIds: selectedTileIds }, (res) => {
    if (!res?.ok) {
      const attempted = res?.word ? ` (${res.word})` : "";
      const msg = `Rejected: ${res?.reason || "unknown"}${attempted}`;
      resultDiv.textContent = msg;
      alert(msg);
      return;
    }
    resultDiv.textContent = `Accepted: ${res.word} (+${res.points})`;
    selectedTileIds = [];
    updateCurrentWord();
  });
}

function renderGame(room) {
  const you = room.players?.[socket.id];
  scorePill.textContent = "Score: " + (you?.score ?? 0);

  poolDiv.innerHTML = "";
  const pool = room.pool || [];
  for (let i = 0; i < 16; i++) {
    const tile = pool[i];
    const el = document.createElement("div");
    el.className = "tile";

    if (!tile) {
      el.style.opacity = 0.22;
      el.style.cursor = "default";
      el.innerHTML = "";
    } else {
      el.innerHTML = tile.letter + "<small>" + tile.value + "</small>";
      el.onclick = () => socket.emit("yoinkTile", { code: room.code, tileId: tile.id });
    }
    poolDiv.appendChild(el);
  }

  bankDiv.innerHTML = "";
  const bank = you?.bank || [];
  bank.forEach((t) => {
    const b = document.createElement("div");
    b.className = "bankTile" + (selectedTileIds.includes(t.id) ? " selected" : "");
    b.textContent = t.letter;
    b.onclick = () => toggleSelect(t.id);
    bankDiv.appendChild(b);
  });
}

let timerInterval = null;
function startTimer(endTime) {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const remaining = Math.max(0, endTime - Date.now());
    const seconds = Math.ceil(remaining / 1000);
    timerDiv.textContent = "Time: " + seconds;
    if (remaining <= 0) clearInterval(timerInterval);
  }, 250);
}
</script>

</body>
</html>
